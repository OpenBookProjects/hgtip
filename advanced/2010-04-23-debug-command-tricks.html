

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
    <head>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <title>Debug Command Tricks / hg tip</title>
        
        
            <link href="http://feeds.feedburner.com/hgtip/" rel="alternate"
                  title="mercurial tips from hgtip.com" type="application/atom+xml" />
        
        
        
            <link rel="stylesheet" href="http://zoomquiet.github.com/hgtip/media/css/aal.css"
                  type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="http://zoomquiet.github.com/hgtip/media/css/calluna.css"
                  type="text/css" media="screen" charset="utf-8" />
            <link rel="stylesheet" href="http://zoomquiet.github.com/hgtip/media/css/style.css"
                  type="text/css" media="screen" charset="utf-8" />
            
        
        
        
        <!--GFW by China http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js-->
            <script type="text/javascript" 
                    src="http://code.jquery.com/jquery-1.4.2.min.js"></script>
            <script type="text/javascript">
                $(document).ready(function() {
                    $('a#rhythm').click(function (){
                        $('body').css('background', 'url(/media/images/rhythm.png) repeat');
                        $('#main-wrap').css('background', 'none');
                        return false;
                    });
                });
            </script>
            <script src="http://mint.hgtip.com/?js" type="text/javascript"></script>
            
        
    </head>
    
    <body>
        <div id="main-wrap">
            <div id="header">            
                <h1><a href="http://zoomquiet.github.com/hgtip">hg tip</a></h1>
                <p id="tagline">学习 Mercurial 羽级技巧;-)</p>
            </div>
            
            <p id="navigation">
                <a href="http://zoomquiet.github.com/hgtip/">所有</a> /
                <a href="http://zoomquiet.github.com/hgtip/beginner/">初级</a> /
                <a href="http://zoomquiet.github.com/hgtip/advanced/">高阶</a>贴士 &mdash;
                <a href="http://hgtip.com/contribute/">contribute</a> &mdash;
                <a href="http://feeds.feedburner.com/hgtip/">feed</a> &mdash;
                <a href="http://twitter.com/hgtip/">twitter</a> &mdash;
                <a href="http://hgtip.com/about/">about</a>  &mdash;
                <a href="http://zoomquiet.github.com/hgtip/2011-10-28-about-translator.html">关于</a>
            </p>
            
            <div id="content">
                
                    <h2>Debug Command Tricks</h2>
                
                
    <p id="tip-info">
        posted by <a href="http://bitbucket.org/face">Friedrich Kastner-Masilko</a>
        on April 23, 2010
    </p>
    
    <!-- Hyde::Article::Begin -->
    
    <p>If you tried <code>hg help --debug</code>, you may be familiar with the commands prefixed
with &#8216;debug&#8217;. Most of them are used to inspect Mercurial&#8217;s internal storage,
but some can come handy in certain situations. Two of these commands are <code>hg
debugsetparents</code> and <code>hg debugrebuildstate</code>.</p>
<p>The first command forces Mercurial to forget the &#8220;real&#8221; parent revisions of a
working-copy in favor of the specified revisions in &#8216;debugsetparents&#8217;. The
second command is forcing Mercurial to rebuild its internal&nbsp;state.</p>
<p>So how can this be useful in normal conditions at all? Here are 3 scenarios
where it comes handy to work with&nbsp;them:</p>
<h3 id="1-late-binding-working-copy-with-repository">1. Late-binding working-copy with&nbsp;repository.</h3>
<p>Imagine an interesting project hosted with Mercurial. At first you only
download a snapshot of the project to inspect the code and try something out.
You didn&#8217;t clone it fully, because you wanted to avoid the overhead to just
check the&nbsp;source.</p>
<p>Later in the process of playing with the code, you realize that this is going
to be a longer-lasting relationship, so you decide to clone the repo and
commit your changes. Since it is quite a big working-copy and you
renamed/deleted/added some files, you don&#8217;t want to copy the whole thing over
some checkout in order to not confuse the working-copy state. So how to commit
this state at the proper&nbsp;location?</p>
<p>The solution is to copy the .hg folder into the snapshot&#8217;s root and&nbsp;issue:</p>
<pre><code>$ hg debugsetparent tip
$ hg debugrebuildstate
$ hg commit -Am "my snapshot"
</code></pre>
<h3 id="2-creating-alternate-check-ins">2. Creating alternate&nbsp;check-ins.</h3>
<p>If you are anything like me, you don&#8217;t trust yourself. Therefore, you&#8217;d want
to add alternative work <span class="caps">BEFORE</span> you delete one of the alternatives. So the
usual workflow of using rollback to take back an ill-composed commit is not
your&nbsp;thing.</p>
<p>Instead, it is possible to&nbsp;simply:</p>
<pre><code>$ hg debugsetparent tip^^
$ hg debugrebuildstate
</code></pre>
<p>And you are back at the state you where before you commited, just with the
&#8220;wrong&#8221; commit still&nbsp;there.</p>
<h3 id="3-simulate-gits-no-ff-merges-with-anonymous-heads">3. Simulate Git&#8217;s &#8212;no-ff merges with anonymous&nbsp;heads.</h3>
<p>Most of the workflows for Git are easily reproducible with Mercurial, but some
of them (<a href="http://nvie.com/git-model">gitflow</a>) use so-called &#8220;non-fast-forward&#8221; merges. These merges
can be done in Mercurial, too, but only with&nbsp;named-branches:</p>
<pre><code>$ hg sl
$ echo x &gt; x
$ hg ci -Am "base"
adding x
$ hg branch feature
marked working directory as branch feature
$ echo y &gt; x
$ hg ci -m "feature"
$ hg up default
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
$ hg merge feature
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
(branch merge, don't forget to commit)
$ hg ci -m "merged"
$ hg glog
@    changeset:   2:e0502e1d12c6
|\   tag:         tip
| |  parent:      0:387ca709aeaf
| |  parent:      1:205ec0dce78f
| |  summary:     merged
| |
| o  changeset:   1:205ec0dce78f
|/   branch:      feature
|    summary:     feature
|
o  changeset:   0:387ca709aeaf
   summary:     base
</code></pre>
<p>As you can see in the above graphlog output, the merge contains no actual
information besides indicating the merging of two named-branches (&#8216;default&#8217;
and &#8216;feature&#8217;). As with Mercurial 1.5.1, you can&#8217;t do that with anonymous&nbsp;heads:</p>
<pre><code>$ echo x &gt; x
$ hg ci -Am "base"
adding x
$ echo y &gt; x
$ hg ci -m "feature"
$ hg up 0
1 files updated, 0 files merged, 0 files removed, 0 files unresolved
$ hg merge 1
abort: nothing to merge (use 'hg update' or check 'hg heads')
</code></pre>
<p>Why would you want to do that with anonymous heads, anyway? Well, one way of
simulating Git branches is the bookmark extension. Unfortunately, using
bookmarks (to name anonymous heads) is still using anonymous heads, so the
above problem gets in your&nbsp;way:</p>
<pre><code>$ hg bookmark master
$ hg bookmark feature -r 1
$ hg bookmark
 * master                    0:6965ee5bb884
   feature                   1:2061809a8e23
$ hg merge feature
abort: nothing to merge (use 'hg update' or check 'hg heads')
</code></pre>
<p>The&nbsp;solution:</p>
<pre><code>$ hg debugsetparents master feature
$ hg revert -a -r feature
reverting x
$ hg ci -m "merged"
$ hg glog
@    changeset:   2:0dfae55684f6
|\   tag:         master
| |  tag:         tip
| |  parent:      0:6965ee5bb884
| |  parent:      1:2061809a8e23
| |  summary:     merged
| |
| o  changeset:   1:2061809a8e23
|/   tag:         feature
|    summary:     feature
|
o  changeset:   0:6965ee5bb884
   summary:     base
</code></pre>
    
    <!-- Hyde::Article::End -->
    
    <div id="tip-comments">
        <h2>评注</h2>
        <div id="disqus_thread"></div><script type="text/javascript" src="http://disqus.com/forums/hgtip/embed.js"></script><noscript><a href="http://hgtip.disqus.com/?url=ref">View the discussion thread.</a></noscript><a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
    </div>

            </div>
            
            <div id="excerpt">
                
                    <!-- Hyde::Excerpt::Begin -->
                        <p>Mercurial has some &#8220;hidden&#8221; debug commands that can make your day in&nbsp;special&nbsp;situations.</p>
                    <!-- Hyde::Excerpt::End -->
                
            </div>
        </div>
        <div id='footer'>
            网站由 <a href="http://stevelosh.com">steve</a> 及 <a href="/http://hgtip.com/about/">其同伙</a> &mdash;
            用 <a href="http://github.com/lakshmivyas/hyde">hyde</a> 创建 &mdash;
            使用 <a href="http://creativecommons.org/licenses/by-sa/3.0/us/">cc-by-sa</a> 许可协议&mdash;
            we've got <a id="rhythm" href="#">rhythm</a>
            <br />
            支持:
            <a href="http://hgtip.com/">english</a> &mdash;
            <a href="http://zoomquiet.github.com/hgtip/">中文</a> &mdash;
            <a href="http://de.hgtip.com/">deutsch</a> &mdash;
            <a href="http://ja.hgtip.com/">日本語</a>
        </div>
        
        
    <script type="text/javascript">
    //<![CDATA[
    (function() {
        var links = document.getElementsByTagName('a');
        var query = '?';
        for(var i = 0; i < links.length; i++) {
        if(links[i].href.indexOf('#disqus_thread') >= 0) {
            query += 'url' + i + '=' + encodeURIComponent(links[i].href) + '&';
        }
        }
        document.write('<script charset="utf-8" type="text/javascript" src="http://disqus.com/forums/hgtip/get_num_replies.js' + query + '"></' + 'script>');
    })();
    //]]>
    </script>

    </body>
</html>

